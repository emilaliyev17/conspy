{% load report_filters %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance Sheet Report</title>
    
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/4.0.1/css/fixedHeader.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/5.0.1/css/fixedColumns.dataTables.min.css">

    <style>
        /* General Page Layout */
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { background-color: white; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .header h1 { margin: 0; font-size: 28px; }
        .nav-menu, .filters, .actions { padding: 15px 20px; border-bottom: 1px solid #dee2e6; }
        .nav-menu a { color: #495057; text-decoration: none; padding: 8px 16px; margin-right: 10px; border-radius: 4px; }
        .nav-menu a.active { background-color: #007bff; color: white; }
        .filter-row { display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap; }
        .filter-group label { font-weight: bold; margin-bottom: 5px; color: #495057; }
        .btn { background-color: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; }
        .btn-success { background-color: #28a745; }
        .btn-secondary { background-color: #6c757d; }
        .table-wrapper { padding: 20px; }

        /* Clean Table Styles */
        #reportTable { width: 100%; border-collapse: collapse; }
        #reportTable th, #reportTable td {
            padding: 8px 10px;
            border: 1px solid #e0e0e0;
            font-size: 11px;
            line-height: 1.2;
            white-space: nowrap;
        }
        #reportTable thead th {
            background: #f5f5f5;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            border-bottom: 2px solid #999;
        }
        #reportTable td:nth-child(n+3) { text-align: right; }
        .th-wrap { display: flex; flex-direction: column; align-items: center; }
        .th-bottom { font-weight: normal; font-size: 10px; }

        /* Row and Column Cosmetics */
        .parent-header-row { background-color: #e8e8e8; font-weight: bold; }
        .sub-header-row { background-color: #f8f9fa; font-weight: bold; }
        .parent-total-row { background-color: #d4edda; font-weight: bold; }
        .check-row { background-color: #f8d7da; font-weight: bold; }
        .company-f2001 { background-color: rgba(173,216,230,0.3) !important; }
        .company-gl001 { background-color: rgba(144,238,144,0.3) !important; }
        .total-column { background-color: rgba(211,211,211,0.4) !important; border-left: 2px solid #bbb; border-right: 2px solid #bbb; }
        .negative { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>Balance Sheet Report</h1></div>
        <div class="nav-menu">
            <a href="{% url 'core:home' %}">üè† Home</a>
            <a href="{% url 'core:upload_chart_of_accounts' %}">üìã Chart of Accounts</a>
            <a href="{% url 'core:upload_financial_data' %}">üí∞ Financial Data</a>
            <a href="{% url 'core:pl_report' %}">üìä P&L Report</a>
            <a href="{% url 'core:bs_report' %}" class="active">üìà Balance Sheet</a>
            <a href="/admin/">‚öôÔ∏è Admin</a>
        </div>
        
        <div class="filters">
            <form method="get">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>From:</label>
                        <select name="from_month">
                            <option value="">Month</option>
                            <option value="1" {% if request.GET.from_month == '1' %}selected{% endif %}>January</option>
                            <option value="2" {% if request.GET.from_month == '2' %}selected{% endif %}>February</option>
                            <option value="3" {% if request.GET.from_month == '3' %}selected{% endif %}>March</option>
                            <option value="4" {% if request.GET.from_month == '4' %}selected{% endif %}>April</option>
                            <option value="5" {% if request.GET.from_month == '5' %}selected{% endif %}>May</option>
                            <option value="6" {% if request.GET.from_month == '6' %}selected{% endif %}>June</option>
                            <option value="7" {% if request.GET.from_month == '7' %}selected{% endif %}>July</option>
                            <option value="8" {% if request.GET.from_month == '8' %}selected{% endif %}>August</option>
                            <option value="9" {% if request.GET.from_month == '9' %}selected{% endif %}>September</option>
                            <option value="10" {% if request.GET.from_month == '10' %}selected{% endif %}>October</option>
                            <option value="11" {% if request.GET.from_month == '11' %}selected{% endif %}>November</option>
                            <option value="12" {% if request.GET.from_month == '12' %}selected{% endif %}>December</option>
                        </select>
                        <select name="from_year">
                            <option value="">Year</option>
                            <option value="2024" {% if request.GET.from_year == '2024' %}selected{% endif %}>2024</option>
                            <option value="2025" {% if request.GET.from_year == '2025' %}selected{% endif %}>2025</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>To:</label>
                        <select name="to_month">
                            <option value="">Month</option>
                            <option value="1" {% if request.GET.to_month == '1' %}selected{% endif %}>January</option>
                            <option value="2" {% if request.GET.to_month == '2' %}selected{% endif %}>February</option>
                            <option value="3" {% if request.GET.to_month == '3' %}selected{% endif %}>March</option>
                            <option value="4" {% if request.GET.to_month == '4' %}selected{% endif %}>April</option>
                            <option value="5" {% if request.GET.to_month == '5' %}selected{% endif %}>May</option>
                            <option value="6" {% if request.GET.to_month == '6' %}selected{% endif %}>June</option>
                            <option value="7" {% if request.GET.to_month == '7' %}selected{% endif %}>July</option>
                            <option value="8" {% if request.GET.to_month == '8' %}selected{% endif %}>August</option>
                            <option value="9" {% if request.GET.to_month == '9' %}selected{% endif %}>September</option>
                            <option value="10" {% if request.GET.to_month == '10' %}selected{% endif %}>October</option>
                            <option value="11" {% if request.GET.to_month == '11' %}selected{% endif %}>November</option>
                            <option value="12" {% if request.GET.to_month == '12' %}selected{% endif %}>December</option>
                        </select>
                        <select name="to_year">
                            <option value="">Year</option>
                            <option value="2024" {% if request.GET.to_year == '2024' %}selected{% endif %}>2024</option>
                            <option value="2025" {% if request.GET.to_year == '2025' %}selected{% endif %}>2025</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Data Type:</label>
                        <select name="data_type" id="data_type">
                            <option value="actual" {% if request.GET.data_type == 'actual' %}selected{% endif %}>Actual</option>
                            <option value="budget" {% if request.GET.data_type == 'budget' %}selected{% endif %}>Budget</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">üîç Apply Filters</button>
                </div>
            </form>
        </div>
        
        <div class="actions">
             <a href="{% url 'core:export_report_excel' %}?type=bs&{{ request.GET.urlencode }}" class="btn btn-success">üì• Export to Excel</a>
             <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Print Report</button>
        </div>

        <div class="table-wrapper">
            {% if report_data %}
            <table id="reportTable" class="display">
                <thead>
                    <tr>
                        <th style="min-width: 150px;">Account Code</th>
                        <th style="min-width: 300px;">Account Name</th>
                        {% for period in periods %}
                            {% for company in companies %}
                                <th class="company-{{ company.code|lower }}"><div class="th-wrap"><span>{{ period|date:"M-y" }}</span><span class="th-bottom">{{ company.code }}</span></div></th>
                            {% endfor %}
                            <th class="total-column"><div class="th-wrap"><span>{{ period|date:"M-y" }}</span><span class="th-bottom">TOTAL</span></div></th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in report_data %}
                    <tr class="{% if row.type == 'parent_header' %}parent-header-row{% elif row.type == 'sub_header' %}sub-header-row{% elif row.type == 'parent_total' %}parent-total-row{% elif row.type == 'check_row' %}check-row{% endif %}">
                        <td>{% if row.type == 'account' %}{{ row.account_code }}{% endif %}</td>
                        <td style="padding-left: {{ row.level|default:0|add:1|multiply:15 }}px;">{{ row.account_name }}</td>
                        {% for period in periods %}
                            {% for company in companies %}
                                {% with amount=row.periods|get_item:period|get_item:company.code %}
                                <td class="company-{{ company.code|lower }} {% if amount < 0 %}negative{% endif %}">{{ amount|format_number }}</td>
                                {% endwith %}
                            {% endfor %}
                            {% with total=row.periods|get_item:period|get_item:'TOTAL' %}
                            <td class="total-column {% if total < 0 %}negative{% endif %}">{{ total|format_number }}</td>
                            {% endwith %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div style="text-align: center; padding: 40px;"><p>No data available for the selected criteria.</p></div>
            {% endif %}
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/4.0.1/js/dataTables.fixedHeader.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/5.0.1/js/dataTables.fixedColumns.min.js"></script>

    <script>
        $(document).ready(function() {
            $('#reportTable').DataTable({
                // Vertical scrolling
                scrollY: '70vh',
                scrollCollapse: true,
                
                // Horizontal scrolling
                scrollX: true,

                // Enable FixedHeader
                fixedHeader: true,

                // NEW: Enable FixedColumns for the first 2 columns
                fixedColumns: {
                    left: 2
                },

                // Disable unnecessary features
                paging: false,
                searching: false,
                info: false,
                ordering: false
            });
        });
    </script>
</body>
</html>
